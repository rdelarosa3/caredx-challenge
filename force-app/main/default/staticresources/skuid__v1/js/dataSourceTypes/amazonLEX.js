!function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=350)}({350:function(e,t,n){"use strict";!function(){var a,c=skuid.$,e=skuid.dataSource,u=e.utils,i=skuid.utils,s=c.Deferred,d=u.deferrable,l=skuid.snippet.getSnippet,f="__",p=i.grab,m=i.makeXMLDoc,g=!0,o={supported:function(){return!!(window.Worker&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(window.AudioContext||window.webkitAudioContext))},getAudioContext:function(){return this.audioContext},setAudioContext:function(e){this.audioContext=e},getAudioStream:function(){return this.audioStream},setAudioStream:function(e){this.audioStream=e},setRecorder:function(e){this.recorder=e},getRecorder:function(){return this.recorder},setCurrentAudioRecorder:function(e){this._audioRecorder=e},getCurrentAudioRecorder:function(){return this._audioRecorder},controller:{startRecording:function(e,t,n){var r=o.getCurrentAudioRecorder().createRecorder();o.setRecorder(r),r.record(e,t,n)},stopRecording:function(){o.getRecorder().stop()},clearRecording:function(e){o.getRecorder().clear(e)},exportWAV:function(e){o.getRecorder().exportWAV(e)},supportsAudio:function(e){if(navigator.mediaDevices.getUserMedia){var t=o.audioRecorder();o.setCurrentAudioRecorder(t),t.requestDevice().then(function(){e(!0)}).catch(function(){e(!1)})}else e(!1)}},createAudioWorker:function(){var e=new Worker(window.URL.createObjectURL(new Blob(["("+this.workerFunction.toString()+")()"],{type:"text/javascript"})));this.worker=e},getAudioWorker:function(){return this.worker},workerFunction:function(){var d,n=0,l=16e3,r=[];function o(e,t,n){for(var r=0;r<n.length;r++)e.setUint8(t+r,n.charCodeAt(r))}self.onmessage=function(e){switch(e.data.command){case"init":!function(e){d=e.sampleRate}(e.data.config);break;case"record":!function(e){r.push(e[0]),n+=e[0].length}(e.data.buffer);break;case"export":!function(){var e=function(e){var t=new ArrayBuffer(44+2*e.length),n=new DataView(t);return o(n,0,"RIFF"),n.setUint32(4,32+2*e.length,!0),o(n,8,"WAVE"),o(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,d,!0),n.setUint32(28,2*d,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),o(n,36,"data"),n.setUint32(40,2*e.length,!0),function(e,t,n){for(var r=0;r<n.length;r++,t+=2){var o=Math.max(-1,Math.min(1,n[r]));e.setInt16(t,o<0?32768*o:32767*o,!0)}}(n,44,e),n}(function(e){if(l===d)return e;var t=d/l,n=Math.round(e.length/t),r=new Float32Array(n),o=0,i=0;for(;o<r.length;){for(var a=Math.round((o+1)*t),c=0,u=0,s=i;s<a&&s<e.length;s++)c+=e[s],u++;r[o]=c/u,o++,i=a}return r}(function(e,t){for(var n=new Float32Array(t),r=0,o=0;o<e.length;o++)n.set(e[o],r),r+=e[o].length;return n}(r,n))),t=new Blob([e],{type:"application/octet-stream"});postMessage(t)}();break;case"clear":n=0,r=[],postMessage("cleared")}}},audioRecorder:function(){var l=this;l.createAudioWorker();var e=l.getAudioWorker(),t=function(e){var o,i,a,c,n,r,u=!1,t=l.getAudioWorker(),s=e.context.createScriptProcessor(4096,1,1);t.onmessage=function(e){var t=e.data;if("cleared"===t)return r();n(t)},t.postMessage({command:"init",config:{sampleRate:e.context.sampleRate}});s.onaudioprocess=function(e){u&&(t.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0)]}),function(){d.fftSize=2048;var e=d.fftSize,t=new Uint8Array(e);d.getByteTimeDomainData(t),"function"==typeof a&&a(t,e);var n=t[0]/128-1;(.01<n||n<-.01)&&(o=Date.now());var r=Date.now()-o;(1e3*c<r||15e3<r)&&i()}())};var d=e.context.createAnalyser();return d.minDecibels=-90,d.maxDecibels=-10,d.smoothingTimeConstant=.85,e.connect(d),d.connect(s),s.connect(e.context.destination),{record:function(e,t,n){i=t,c=e,a=n,o=Date.now(),u=!0},stop:function(){u=!1},clear:function(e){r=e,t.postMessage({command:"clear"})},exportWAV:function(e){n=e,t.postMessage({command:"export"})}}};return{requestDevice:function(){return void 0===o.getAudioContext()&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,o.setAudioContext(new AudioContext)),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){o.setAudioStream(e)})},createRecorder:function(){return t(o.getAudioContext().createMediaStreamSource(o.getAudioStream(),e))}}}},r=o.controller,v="LexModelBuildingService";function h(e,t,n){var r={};return n&&(r.sessionAttributes=n),r.botName=t.botName,r.botAlias=t.botAlias,i.isString(e)?r.inputText=e:(r.contentType="audio/x-l16; sample-rate=16000",r.inputStream=e,r.accept="audio/mpeg"),r.userId=i.userInfo.sessionId,r}function b(e){if(e.audioStream&&e.audioStream.data.length&&g){var t=function(e){var n=new Uint8Array(e.length);return c.each(e,function(e,t){n[e]=t}),n}(e.audioStream.data),n=new Blob([t],{type:"audio/mpeg"}),r=document.createElement("audio"),o=window.URL.createObjectURL(n),i=s();return r.src=o,r.addEventListener("ended",function(){return r.currentTime=0,c(r).remove(),i.resolve()}),(a=r).play(),i.promise()}}function x(e){return-1!==["ElicitIntent","ConfirmIntent","ElicitSlot"].indexOf(e.dialogState)}function A(e,t,n,r){var o={},i="application/json";if(n.convertToFormData){var a=new FormData;c.each(e,function(e,t){a.append(e,t)}),o=a,i=!1}else(o=n).body=e;return r=r||"/core/data/aws-lex",skuid.ajax.direct({url:r,type:"POST",body:o,cache:!1,processData:!1,contentType:i,headers:{"x-skuid-data-source-name":t.name}})}function w(e){return e.sessionAttributes}function S(e){delete e.LEXSessionAttributes}function y(n){c.each(["textSubmissionHandler","responseHandler","endOfConversationHandler"],function(e,t){n[t]||(n[t]=function(){})})}function k(n,r,o){var t,i;return g=!0,y(n),n.listeningHandler(),R.recordMessageForLex(n.silenceTime).then(function(e){var t=h(e,n,o);return n.processingHandler(),A(t,r,{convertToFormData:!0},"/core/data/aws-lex/send-audio")}).then(function(e){return t=e.body,i=x(t),d(n.textSubmissionHandler(t.inputTranscript,i))}).then(function(){return c.when.all([b(t),d(n.responseHandler(t.message,t))])}).then(function(){return o=w(t),i?R.talkToLex(n,r,o):d(n.endOfConversationHandler(t)).then(function(){return S(r),c.extend({},{$LEX:t.slots},{intentName:t.intentName})})})}var C=function(e,t){var n={},r=function(t,n){return function(e){return i.mergeAsTextInContext(t.attr(e),n)}}(e,t);n.botAlias=r("botalias"),n.botName=r("botname"),n.silenceTime=r("silencetime"),n.text=r("text");var o=function(n){return function(e){var t=n.attr(e);return l(t)||function(){}}}(e);return n.responseHandler=o("response-snippet"),n.textSubmissionHandler=o("text-conversion-snippet"),n.endOfConversationHandler=o("end-of-conversation-snippet"),n.processingHandler=o("processing-audio-snippet"),n.listeningHandler=o("listening-snippet-snippet"),n},R=new e.DataSourceType({name:"AmazonLEX",getActions:u.getActionsStatic,createActions:function(){return{"listen-for-intent":{deprecated:!0,runtimeExecution:function(e,t,n,r){R.resetLex(r);var o=C(e,n);return R.talkToLex(o,r)}},"send-text":{deprecated:!0,runtimeExecution:function(e,t,n,r){var o=C(e,n);return R.textLex(o,r)}}}},modelable:!1,recordMessageForLex:function(t){t=t||1.5;var n=s();return o.controller.supportsAudio(function(e){e||n.reject("Need microphone access!"),o.controller.startRecording(t,function(){r.stopRecording(),function(){var t=s();return r.exportWAV(function(e){r.clearRecording(function(){t.resolve(e)})}),t}().then(function(e){n.resolve(e)},function(e){n.reject(e)})})}),n},textLex:function(t,n){var r,e=h(t.text,t,n.LEXSessionAttributes);return y(t),d(t.textSubmissionHandler(t.text,n)).then(function(){return A(e,n,{method:"postText",sdk:"LexRuntime"})}).then(function(e){return r=e.body,n.LEXSessionAttributes=w(r),d(t.responseHandler(r.message,r,n))}).then(function(){if(!x(r))return S(n),d(t.endOfConversationHandler(r,n))})},resetLex:S,voiceCommands:{props:{page:function(){return[{id:"lex-chatbotname",label:"Chatbot Name",type:"string"},{id:"lex-chatbotalias",label:"Chatbot Alias",type:"string"}]},actionSequence:{topLevelProps:function(o,i){return[{id:"voice-command",label:"Intent",type:"combobox",entries:function(){return function(e){var t=skuid.builder.core.getPageXML(),n=t.attr("lex-chatbotname"),r=t.attr("lex-chatbotalias");return r&&n?A({name:n,versionOrAlias:r},e,{method:"getBot",sdk:v}).then(function(e){var t=e.body.intents;return c.map(t,function(e){return{value:e.intentName+f+e.intentVersion,label:e.intentName}})}):u.rejectable("Need to specify both a chatbot name and chatbot alias")}(i)},onChange:function(e){var t=e.split(f);if(1<t.length){var n=t[0],r=t[1];(function(e,t,n){return A({version:n,name:t},e,{method:"getIntent",sdk:v})})(i,n,r).then(function(e){if(e){var t=function(e){return p(e,"body","slots")}(e),n=function(e){return p(e,"body","sampleUtterances")}(e);t&&function(e,t){var n=e.state,r=n.children("inputs");r.length||(r=m("<inputs/>")).appendTo(n),r.empty(),c.each(t,function(e,t){r.append(m('<input name="'+t.name+'" type="value"/>'))}),e.save().rebuildProps()}(o,t),n&&function(e,t){var n=e.state;3<t.length&&(t=t.slice(0,3));var r=n.children("example-commands");r.length||(r=m("<example-commands/>")).appendTo(n),r.empty(),c.each(t,function(e,t){r.append(m('<example-command value="'+t+'"/>'))}),e.save().rebuildProps()}(o,n)}})}},state:o.state}]},shouldHaveInputs:function(e){return e.attr("voice-command")}},action:function(){return[{id:"silencetime",defaultValue:"1.5",label:"Silence wait time (seconds)",helptext:"How long Skuid should wait, in seconds, after a user finishes speaking before sending the voice command",type:"picklist",picklistEntries:c.map(["1","1.5","2","2.5","3"],function(e){return{label:e,value:e}})}]}},methods:{beginConversation:function(e,t,n,r){var o=u.convertToNumber(t.attr("silencetime"))||1.5;return k({botAlias:n["lex-chatbotalias"],botName:n["lex-chatbotname"],silenceTime:o,responseHandler:r.responseHandler||function(){},textSubmissionHandler:r.textSubmissionHandler||function(){},endOfConversationHandler:r.endOfConversationHandler||function(){},processingHandler:r.processingHandler||function(){},listeningHandler:r.listeningHandler||function(){}},e).then(function(e){for(var t,n=e.intentName,r=e.$LEX,o=skuid.actionSequences.getAllVoiceCommandListeners(),i=0;i<o.length;i++)if((t=o[i]).getVoiceCommandId().split(f)[0]===n)return{actionSequence:t,inputs:r}})},conversationKillSwitch:function(){r&&r.stopRecording(),g=!1,a&&(a.pause(),a.currentTime=0,c(a).remove(),a=void 0)}}},talkToLex:k,LexThinksConversationIsOngoing:x,_convertTextActionDefToParams:C})}()}});