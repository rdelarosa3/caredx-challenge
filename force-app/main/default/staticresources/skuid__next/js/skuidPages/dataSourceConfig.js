skuid.runtime.registerApi("v2","skuidPages/dataSourceConfig",function(e){var t=function(e){var t={};function n(a){if(t[a]){return t[a].exports}var r=t[a]={i:a,l:false,exports:{}};e[a].call(r.exports,r,r.exports,n);r.l=true;return r.exports}n.m=e;n.c=t;n.d=function(e,t,a){if(!n.o(e,t)){Object.defineProperty(e,t,{enumerable:true,get:a})}};n.r=function(e){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})};n.t=function(e,t){if(t&1)e=n(e);if(t&8)return e;if(t&4&&typeof e==="object"&&e&&e.__esModule)return e;var a=Object.create(null);n.r(a);Object.defineProperty(a,"default",{enumerable:true,value:e});if(t&2&&typeof e!="string")for(var r in e)n.d(a,r,function(t){return e[t]}.bind(null,r));return a};n.n=function(e){var t=e&&e.__esModule?function t(){return e["default"]}:function t(){return e};n.d(t,"a",t);return t};n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};n.p="";return n(n.s=695)}({695:function(t,n){(function(e){const t=e.snippet.register,n=e.componentType.register,a=e.$,r=e.utils,o=e.constants,s=o.MIME_TYPES.JSON,i=e.platform.getEntityFieldName,c=e.platform.getEntityFieldNames,u=o.SALESFORCE;t("DSC_Value_Editor",function(t,n){let a=t.metadata.displaytype,r=t.mode;if(t.row.type==="userinfo"){t.metadata.picklistEntries=["Email","Federation Id","First Name","Last Name","Site Id","Username","User Id"].map(e=>{return{label:e,value:e.split(" ").map(e=>e.toLowerCase()).join("_")}});t.required=true;a="PICKLIST";if(t.mode==="read"||t.mode==="readonly"){r="read"}else{r="edit"}}else{t.required=false}e.ui.fieldRenderers[a][r](t,n)});t("BuildProfilePermissionSummary",function(){let t=arguments[0],n=t.model;let r=["createable","deleteable","queryable","updateable"];let o=e.$M("Profile");let s={};a.each(n.data,function(e,t){let n=t["permission_set_id"];s[n]={};a.each(r,function(e,a){s[n][a]=t[a]})});let c={};a.each(o.getRows(),function(e,t){const n=s[t[i("profile","name")]];const o=c[t[i("profile","id")]]={};a.each(r,function(e,t){if(n){o[t]=n[t]}})});o.updateRows(c);o.hasChanged=false;o.originals=a.extend({},o.changes);o.changes={};o.cancel()});t("buildPermissionCache",function(){const t=arguments[0],n=t.model,r={};let o,s,i;switch(n.id){case"DataSourceObjectPermissions":o="data_source_object_id";s="stng__DataSourceObjects";i={queryable:"queryable",createable:"createable",updateable:"updateable",deleteable:"deleteable"};break;case"DataSourceFieldPermissions":o="data_source_field_id";s="stng__DataSourceFields";i={queryable:"queryable",createable:"createable",updateable:"updateable"};break;case"DataSourceConditionPermissions":o="data_source_condition_id";s="stng__DataSourceConditions";i={alwaysOn:"always_on"};break}if(!o)return;let c=e.$M(s);a.each(n.data,function(e,t){let n=t[o];r[n]={};a.each(i,function(e,a){r[n][a]=t[e]})});let u={};a.each(c.getRows(),function(e,t){const n=r[t.id];const o=u[t.id]={};a.each(i,function(e,t){if(n){o[t]=n[t]}})});c.updateRows(u);c.hasChanged=false;c.originals=a.extend({},c.changes);c.changes={};c.cancel()});t("saveScheme",function(){let t=S().getFirstRow();let n=e.$M("stng__DataSourceObjects").getFirstRow();let r=e.$M("stng__DataSourceFields");let o=e.$M("stng__DataSourceConditions");let i=e.$M("Profile").getFirstRow();let c={name:i[e.platform.getEntityFieldName("profile","name")],dataSourcePermissions:{}};let u={dataSourceObjectPermissions:{}};let l={createable:!!n.createable,queryable:!!n.queryable,updateable:!!n.updateable,deleteable:!!n.deleteable,dataSourceFieldPermissions:{},dataSourceConditionPermissions:{}};a.each(r.data,function(e,t){l.dataSourceFieldPermissions[t.name]={createable:!!t.createable,queryable:!!t.queryable,updateable:!!t.updateable}});a.each(o.data,function(e,t){l.dataSourceConditionPermissions[t.name]={alwaysOn:!!t.always_on}});u["dataSourceObjectPermissions"][n.name]=l;c.dataSourcePermissions[t.name]=u;return g().then(e=>{return a.ajax({url:T()+"/api/v2/permissionsets",method:"PATCH",headers:e,data:JSON.stringify(c),contentType:s,dataType:"json"})})});t("validateDataServiceName",function(){let t=e.component.getByType("skuid__page")[0],n=e.$M("stng__DataServices"),o=n.changes,s=/^[a-z0-9_-]+$/i;return r.resolve().then(function(){a.each(o,function(e,n){if(n.Name&&"Name"in n){let e=s.exec(n.Name);if(!e){let e="The name must only contain alpha-numeric characters, underscores, and dashes";t.addProblem(e);throw e}}})})});function l(e){let t="",n=e.responseJSON;if(n){if(n.error)t+=n.error;if(n.message){t+=(t?": ":"")+n.message}}else{t+=e.responseText}return t}function d(e){return r.reject({$PreviousAction:{error:l(e)}})}function f(e){const t=l(e);if(p(t)){const e=S();e.updateRow(e.getFirstRow(),"dso_import_error",t)}return r.reject({$PreviousAction:{error:t}})}function m(e){S().cancel();return e}function p(e){const t=e.split("\n\n");return t.length===3&&t[0]==="The import could not be completed because of missing related objects."}function g(){return e.utils.Identity.getAPIToken().then(t=>{const n={Accept:s,"Content-Type":s,Authorization:"Bearer ".concat(t.jwt),"x-skuid-public-key-endpoint":e.platform.getPublicKeyEndpoint()};if(r.inPlatform([o.VISUALFORCE,o.LIGHTNING])){n["x-skuid-session-id"]=e.utils.userInfo.sessionId}return n})}function _(){return e.$M("stng__DataSources")||e.$M("stng__ModelDataSources")}function S(){return e.$M("stng__DataSource_Warden")}function h(){return e.$M("stng__DSOImport")}function b(){return e.$M("stng__DataServices")}function y(){return e.$M("stng__SiteEnv")}function v(){return y().getFirstRow()}function D(){return _().getFirstRow()}function P(t,n,a){const r={[e.platform.getEntityFieldName("data_service","is_active")]:true};if(a&&a.version){r[e.platform.getEntityFieldName("data_service","version")]=a.version}if(t&&n){t.updateRow(n,r);return t.save()}}function w(){const e=_();const t=D();const n=b();const{data_service_id:a,data_service:r}=c("data_source");const o=e.getFieldValue(t,a,true);let s=e.getFieldValue(t,r,true);if(!s&&o){s=t[r]=n.getRowById(o)}if(!o){const{PLINY_WARDEN_HOST:e,PLINY_WARDEN_PORT:t,PLINY_WARDEN_VERSION:n}=v();const{host:a,port:r,version:o}=c("data_service");s={[a]:e,[r]:t,[o]:n}}return s}function R(e){const t=e[i("data_service","host")],n=e[i("data_service","port")];return"https://".concat(t)+(n?":".concat(n):"")}function T(){return R(w())}function O(t,n,a){const r=w()[e.platform.getEntityFieldName("data_service","version")];if(r){const e=r.split(".");if(e.length==3){const[r,o,s]=e.map(e=>parseInt(e,10));if(r>=t&&o>=n&&s>=a){return true}}}return false}function E(){const t=D();return t[e.platform.getEntityFieldName("data_source",O(0,2,3)?"name":"external_id")]}function A(){return"".concat(N(),"/source-entity")}function N(){return"".concat(T(),"/api/v2/datasources/").concat(E())}function I({name:e,schema:t}){let n=e,a=r.capitalizeFirst(e),o=a;if(t){n+="_"+t}if(!r.endsWith(o,"s")){if(r.endsWith(o,"y")){o=o.substring(0,o.length-1)+"ies"}else{o+="s"}}return{entity:e,label:a,labelPlural:o,name:n,schema:t,tableName:e}}function F(){const t=e.$M("stng__DSOImport_Dependencies");const n=S();const a=h();const r=n.getFieldValue(n.getFirstRow(),"dso_import_error");if(p(r)){const e=r.split("\n\n");const n=e[1].split("\n");n.forEach(e=>{const n=e.split(", ");const r=n[0].substring("Table: ".length);const o=n[1].substring("Schema: ".length);const s=a.getRows([{field:"name",value:r},{field:"schema",value:o}]);if(s.length>0){t.adoptRows(s)}})}const o=t.getRows();let s;return C(o).catch(e=>{if(e.$PreviousAction&&e.$PreviousAction.error){const t=e.$PreviousAction.error;if(t&&t!=s&&p(t)){return F()}}return e})}function C(e){return g().then(t=>{return a.ajax({url:A(),method:"PATCH",headers:t,data:JSON.stringify({operation:"import",payload:Array.isArray(e)?e.map(I):[I(e)]}),contentType:s,dataType:"json"}).then(m).catch(f)})}function M(e,t){const n=t?R(t):T();return g().then(r=>{return a.ajax({url:"".concat(n,"/api/v2/ping"),method:"GET",headers:r}).then(n=>{return P(e,t,n)})})}function k(t,n){return g().then(r=>{const o=e.utils.userInfo.organizationId;const s=n?R(n):T();return a.ajax({url:"".concat(s,"/api/v2/site/").concat(o,"/register"),method:"POST",headers:r}).then(e=>{return P(t,n,e)})})}t("skuid.settings.dataSources.pingDataService",e=>{return M(e.model,e.row).catch(d)});t("skuid.settings.dataSources.registerDataService",e=>{return k(e.model,e.row).catch(d)});t("skuid.settings.dataSources.populateDefaultDataService",()=>{return e.platform.getDefaultDataService().then(t=>{e.$M("stng__SiteEnv").adoptRow(["WARDEN_HOST","WARDEN_PORT","WARDEN_VERSION","OUTBOUND_IP_ADDRESSES"].reduce((e,n)=>{const a="PLINY_".concat(n);if(t[a])e[a]=t[a];return e},{}))})});t("testConnection",()=>{return g().then(e=>{return a.ajax({url:"".concat(N(),"/poke"),method:"GET",headers:e,contentType:s,dataType:"json"})}).then($).catch(x)});t("addDependentTablesAndRetry",()=>{return F()});t("importDSO",({row:e})=>{return C(e)});t("importMultipleDSOs",({rows:e})=>{return O(0,2,4)?C(e):Promise.all(e.map(C))});t("importDSOS",()=>{let t=e.$;return g().then(e=>{return t.ajax({url:A(),headers:e}).then(function(e){let n=h();n.abandonAllRows();n.adoptRows(t.map(e,function(e){return{name:e.tablename,schema:e.tableschema}}))}).catch(d)})});n("outboundIPsComponent",e=>{let t=y();let n=t.getFirstRow();let r=n&&t.getFieldValue(n,"PLINY_OUTBOUND_IP_ADDRESSES");if(r&&r.length){let t=a("<h3>").text("Skuid Outbound Connection IP Addresses");let n=a("<p>").text("Skuid may use any one of the following static IP addresses to connect directly from the cloud to your datasources.");let o=a("<p>").text("If you use a firewall for your datasources, these IP addresses may need to be whitelisted on your firewall.");let s=a("<ul>");a.each(r,(e,t)=>{s.append(a("<li>").text(t))});e.append(t,n,o,s)}});function j(){let e=S().getFirstRow();let t=D();let n={url:e.url,database_username:e.database_username,database_password:e.database_password,database_name:e.database_name,database_username_config:e.database_username_config,database_password_config:e.database_password_config,database_name_config:e.database_name_config,type:t[i("data_source","type")]};L(n);let r="".concat(T(),"/api/v2/datasources/poke");return g().then(e=>{return a.ajax({url:r,method:"POST",headers:e,data:JSON.stringify(n),contentType:s,dataType:"json"})}).then($).catch(x)}function $(){let t=e.model.getModel("stng__ConnectionTest");let n=t.createRow();n.status="Success!";n.message="The Data Source appears to be correctly configured.";t.save();return true}function x(t){let n=e.model.getModel("stng__ConnectionTest");let a=n.createRow();a.status="Unsuccessful.";a.message="Skuid could not connect to the Data Source.\n";a.message+="Please check all configuration values and make sure the Data Source ";a.message+="can be accessed from Skuid's web servers in your region.\n\n";if(t&&t.responseJSON&&t.responseJSON.message){a.message+=t.responseJSON.message}else if(t&&t.statusText&&t.statusText!=="timeout"){a.message+=t.statusText}n.save();return true}t("testNewConn",()=>{return j()});function L(e){if(!e){return}let t="env_specific_config_map";let n={database_username_config:"database_username",database_password_config:"database_password",database_name_config:"database_name"};for(let a in n){if(e[a]){e[t]={};break}}for(let a in n){if(e[a]){let r=e[a];e[t][n[a]]={id:r}}delete e[a]}}function q(){let e=arguments[0],t=e.changes,n=e.model.data[0];L(t);L(n);return t}t("dataSourceVariableMerge",q);new e.formula.FormulaFunction("GET_FEATURE_VALUE",function(t){const n=e.features[t];return n?n.value:0},{argCount:1,namespace:"skuid_stng",returnType:o.JS_TYPES.STRING});const z=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)+([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^[a-zA-Z0-9_-]+$/;new e.formula.FormulaFunction("IS_VALID_HOST_OR_IP_ADDRESS",e=>z.test(e),{argCount:1,namespace:"skuid_stng",returnType:o.JS_TYPES.BOOLEAN});function J(){const t=e.$M("stng__DataServiceSettings");t.emptyData();return e.remote.promisify(e.remote(),"getDataServiceConfig").then(e=>{t.adoptRow(e)})}function V(){const t=e.$M("stng__ModifyDataServiceSettings");const n=t.getFirstRow();const a=t.getRowChanges(n);const o=e.dataSource.get(u);const s=e.dataSource.getType(u);let i;function c(){return s.makeMetadataApiRequest({dataSource:o,body:"<checkDeployStatus><id>".concat(i,"</id></checkDeployStatus>")})}function l(){return r.delay(500).then(c).then(e=>{if(e.done==="true"){if(e.success==="true"){return"Job Succeeded"}else{throw Error("Job failed: "+e.details)}}else{return l()}})}return e.remote.promisify(e.remote(),"modifyDataServiceConfig",JSON.stringify(a)).then(e=>{i=e;return l()}).then(J).catch(e=>{return r.reject({$PreviousAction:{error:e}})})}function U(){if(r.inPlatform(o.VISUALFORCE)){return e.sfdc.api.query("SELECT DeveloperName,MasterLabel FROM Certificate ORDER BY MasterLabel",{useToolingApi:true}).then(e=>{return e.records.map(({DeveloperName:e,MasterLabel:t})=>{return{label:t,value:e}})})}else{return r.resolve([])}}t("skuid.settings.dataSources.getCertificates",U);t("skuid.settings.dataSources.queryDataServiceConfig",J);t("skuid.settings.dataSources.modifyDataServiceConfig",V);e.events.subscribe("skuid.settings.jwtSigningCertificateChanged",e.utils.Identity.refreshAPIToken)})(e)}});return t});