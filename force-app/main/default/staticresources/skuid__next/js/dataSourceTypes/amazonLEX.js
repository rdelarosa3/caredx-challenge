skuid.runtime.registerApi("v2","dataSourceTypes/amazonLEX",function(e){var t=function(e){var t={};function n(r){if(t[r]){return t[r].exports}var o=t[r]={i:r,l:false,exports:{}};e[r].call(o.exports,o,o.exports,n);o.l=true;return o.exports}n.m=e;n.c=t;n.d=function(e,t,r){if(!n.o(e,t)){Object.defineProperty(e,t,{enumerable:true,get:r})}};n.r=function(e){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})};n.t=function(e,t){if(t&1)e=n(e);if(t&8)return e;if(t&4&&typeof e==="object"&&e&&e.__esModule)return e;var r=Object.create(null);n.r(r);Object.defineProperty(r,"default",{enumerable:true,value:e});if(t&2&&typeof e!="string")for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r};n.n=function(e){var t=e&&e.__esModule?function t(){return e["default"]}:function t(){return e};n.d(t,"a",t);return t};n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};n.p="";return n(n.s=707)}({707:function(t,n,r){"use strict";(function(){let t=e.$,n=e.dataSource,r=n.utils,o=e.utils,i=o.Deferred,a=r.deferrable,u=e.snippet.getSnippet,c="__",s=o.grab,l=o.makeXMLDoc,d=15e3,f,p=true;let m={supported:function e(){if(!window.Worker||!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)||!(window.AudioContext||window.webkitAudioContext))return false;else return true},getAudioContext:function e(){return this.audioContext},setAudioContext:function e(t){this.audioContext=t},getAudioStream:function e(){return this.audioStream},setAudioStream:function e(t){this.audioStream=t},setRecorder:function e(t){this.recorder=t},getRecorder:function e(){return this.recorder},setCurrentAudioRecorder:function e(t){this._audioRecorder=t},getCurrentAudioRecorder:function e(){return this._audioRecorder},controller:{startRecording:function e(t,n,r){let o=m.getCurrentAudioRecorder().createRecorder();m.setRecorder(o);o.record(t,n,r)},stopRecording:function e(){m.getRecorder().stop()},clearRecording:function e(t){m.getRecorder().clear(t)},exportWAV:function e(t){m.getRecorder().exportWAV(t)},supportsAudio:function e(t){if(navigator.mediaDevices.getUserMedia){let e=m.audioRecorder();m.setCurrentAudioRecorder(e);e.requestDevice().then(function(){t(true)}).catch(function(){t(false)})}else{t(false)}}},createAudioWorker:function e(){let t=this,n=new Worker(window.URL.createObjectURL(new Blob(["("+t.workerFunction.toString()+")()"],{type:"text/javascript"})));t.worker=n},getAudioWorker:function e(){return this.worker},workerFunction:function e(){let t=0,n=16e3,r=[],o;self.onmessage=function(e){switch(e.data.command){case"init":i(e.data.config);break;case"record":a(e.data.buffer);break;case"export":u();break;case"clear":c();break}};function i(e){o=e.sampleRate}function a(e){r.push(e[0]);t+=e[0].length}function u(){let e=l(r,t);let o=s(e,n);let i=p(o);let a=new Blob([i],{type:"application/octet-stream"});postMessage(a)}function c(){t=0;r=[];postMessage("cleared")}function s(e){if(n===o){return e}let t=o/n;let r=Math.round(e.length/t);let i=new Float32Array(r);let a=0;let u=0;while(a<i.length){let n=Math.round((a+1)*t);let r=0,o=0;for(let t=u;t<n&&t<e.length;t++){r+=e[t];o++}i[a]=r/o;a++;u=n}return i}function l(e,t){let n=new Float32Array(t);let r=0;for(let t=0;t<e.length;t++){n.set(e[t],r);r+=e[t].length}return n}function d(e,t,n){for(let r=0;r<n.length;r++,t+=2){let o=Math.max(-1,Math.min(1,n[r]));e.setInt16(t,o<0?o*32768:o*32767,true)}}function f(e,t,n){for(let r=0;r<n.length;r++){e.setUint8(t+r,n.charCodeAt(r))}}function p(e){let t=new ArrayBuffer(44+e.length*2);let n=new DataView(t);f(n,0,"RIFF");n.setUint32(4,32+e.length*2,true);f(n,8,"WAVE");f(n,12,"fmt ");n.setUint32(16,16,true);n.setUint16(20,1,true);n.setUint16(22,1,true);n.setUint32(24,o,true);n.setUint32(28,o*2,true);n.setUint16(32,2,true);n.setUint16(34,16,true);f(n,36,"data");n.setUint32(40,e.length*2,true);d(n,44,e);return n}},audioRecorder:function e(){let t=this;t.createAudioWorker();let n=t.getAudioWorker();let r=function e(n){let r=false,o,i,a,u,c=t.getAudioWorker();let s=n.context.createScriptProcessor(4096,1,1);let l,f;c.onmessage=function(e){let t=e.data;if(t==="cleared"){return f()}l(t)};c.postMessage({command:"init",config:{sampleRate:n.context.sampleRate}});let p=function e(t,n,c){i=n;u=t;a=c;o=Date.now();r=true};let m=function e(){r=false};let g=function e(t){f=t;c.postMessage({command:"clear"})};let h=function e(t){l=t;c.postMessage({command:"export"})};let b=function e(){x.fftSize=2048;let t=x.fftSize;let n=new Uint8Array(t);x.getByteTimeDomainData(n);if(typeof a==="function"){a(n,t)}let r=n[0]/128-1;if(r>.01||r<-.01){o=Date.now()}let c=Date.now();let s=c-o;if(s>u*1e3||s>d){i()}};s.onaudioprocess=function(e){if(!r){return}c.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0)]});b()};let x=n.context.createAnalyser();x.minDecibels=-90;x.maxDecibels=-10;x.smoothingTimeConstant=.85;n.connect(x);x.connect(s);s.connect(n.context.destination);return{record:p,stop:m,clear:g,exportWAV:h}};let o=function e(){if(typeof m.getAudioContext()==="undefined"){window.AudioContext=window.AudioContext||window.webkitAudioContext;m.setAudioContext(new AudioContext)}return navigator.mediaDevices.getUserMedia({audio:true}).then(function(e){m.setAudioStream(e)})};let i=function e(){return r(m.getAudioContext().createMediaStreamSource(m.getAudioStream(),n))};return{requestDevice:o,createRecorder:i}}};let g=m.controller,h=function e(){g.stopRecording()},b=function e(){let t=i();g.exportWAV(function(e){g.clearRecording(function(){t.resolve(e)})});return t};let x=function e(){g&&g.stopRecording();p=false;if(f){f.pause();f.currentTime=0;t(f).remove();f=undefined}};let v=function e(t){t=t||1.5;let n=i();m.controller.supportsAudio(function(e){if(!e){n.reject("Need microphone access!")}m.controller.startRecording(t,function(){h();b().then(function(e){n.resolve(e)},function(e){n.reject(e)})})});return n};let A="LexRuntime",w="LexModelBuildingService";function S(n){let o=e.builder.core,i=o.getPageXML(),a=i.attr("lex-chatbotname"),u=i.attr("lex-chatbotalias");if(!u||!a)return r.rejectable("Need to specify both a chatbot name and chatbot alias");return U({name:a,versionOrAlias:u},n,{method:"getBot",sdk:w}).then(function(e){let n=e.body.intents;return t.map(n,function(e){return{value:e.intentName+c+e.intentVersion,label:e.intentName}})})}function y(e,t,n){return U({version:n,name:t},e,{method:"getIntent",sdk:w})}function C(e){return s(e,"body","slots")}function R(e){return s(e,"body","sampleUtterances")}function k(e,n){let r=e.state;let o=r.children("inputs");if(!o.length){o=l("<inputs/>");o.appendTo(r)}o.empty();t.each(n,function(e,t){o.append(l('<input name="'+t.name+'" type="value"/>'))});e.save().rebuildProps()}function T(e,n){let r=e.state;if(n.length>3){n=n.slice(0,3)}let o=r.children("example-commands");if(!o.length){o=l("<example-commands/>");o.appendTo(r)}o.empty();t.each(n,function(e,t){o.append(l('<example-command value="'+t+'"/>'))});e.save().rebuildProps()}function H(e,t,n){let r={};if(n){r.sessionAttributes=n}r.botName=t.botName;r.botAlias=t.botAlias;if(o.isString(e)){r.inputText=e}else{r.contentType="audio/x-l16; sample-rate=16000";r.inputStream=e;r.accept="audio/mpeg"}r.userId=O();return r}function L(e){let n=new Uint8Array(e.length);t.each(e,function(e,t){n[e]=t});return n}function D(e){if(!e.audioStream||!e.audioStream.data.length||!p)return;let n=L(e.audioStream.data),r=new Blob([n],{type:"audio/mpeg"}),o=document.createElement("audio"),a=window.URL.createObjectURL(r),u=i();o.src=a;o.addEventListener("ended",function(){o.currentTime=0;t(o).remove();return u.resolve()});f=o;o.play();return u.promise()}function M(e){return["ElicitIntent","ConfirmIntent","ElicitSlot"].indexOf(e.dialogState)!==-1}function U(n,r,o,i){let a={};let u="application/json";if(o.convertToFormData){let e=new FormData;t.each(n,function(t,n){e.append(t,n)});a=e;u=false}else{a=o;a.body=n}i=i||"/core/data/aws-lex";return e.ajax.direct({url:i,type:"POST",body:a,cache:false,processData:false,contentType:u,headers:{"x-skuid-data-source-name":r.name}})}function O(){return o.userInfo.sessionId}function j(e){return e.sessionAttributes}function E(e){delete e.LEXSessionAttributes}function I(e){let n=["textSubmissionHandler","responseHandler","endOfConversationHandler"];t.each(n,function(t,n){if(!e[n])e[n]=function(){}})}function N(e,t){let n=H(e.text,e,t.LEXSessionAttributes);let r;I(e);return a(e.textSubmissionHandler(e.text,t)).then(function(){return U(n,t,{method:"postText",sdk:A})}).then(function(n){r=n.body;t.LEXSessionAttributes=j(r);return a(e.responseHandler(r.message,r,t))}).then(function(){if(!M(r)){E(t);return a(e.endOfConversationHandler(r,t))}})}function P(e,n,r){let o,i;p=true;I(e);e.listeningHandler();return V.recordMessageForLex(e.silenceTime).then(function(t){let o=H(t,e,r);e.processingHandler();return U(o,n,{convertToFormData:true},"/core/data/aws-lex/send-audio")}).then(function(t){o=t.body;i=M(o);return a(e.textSubmissionHandler(o.inputTranscript,i))}).then(function(){return Promise.all([D(o),a(e.responseHandler(o.message,o))])}).then(function(){r=j(o);if(i){return V.talkToLex(e,n,r)}return a(e.endOfConversationHandler(o)).then(function(){E(n);return t.extend({},{$LEX:o.slots},{intentName:o.intentName})})})}let W=function e(t,n){return function(e){return o.mergeAsTextInContext(t.attr(e),n)}};let F=function e(t){return function(e){let n=t.attr(e);return u(n)||function(){}}};let _=function e(t,n){let r={},o=W(t,n);r.botAlias=o("botalias");r.botName=o("botname");r.silenceTime=o("silencetime");r.text=o("text");let i=F(t);r.responseHandler=i("response-snippet");r.textSubmissionHandler=i("text-conversion-snippet");r.endOfConversationHandler=i("end-of-conversation-snippet");r.processingHandler=i("processing-audio-snippet");r.listeningHandler=i("listening-snippet-snippet");return r};let V=new n.DataSourceType({name:"AmazonLEX",getActions:r.getActionsStatic,createActions:function e(){return{"listen-for-intent":{deprecated:true,runtimeExecution:function e(t,n,r,o){V.resetLex(o);let i=_(t,r);return V.talkToLex(i,o)}},"send-text":{deprecated:true,runtimeExecution:function e(t,n,r,o){let i=_(t,r);return V.textLex(i,o)}}}},modelable:false,recordMessageForLex:v,textLex:N,resetLex:E,voiceCommands:{props:{page:function e(){return[{id:"lex-chatbotname",label:"Chatbot Name",type:"string"},{id:"lex-chatbotalias",label:"Chatbot Alias",type:"string"}]},actionSequence:{topLevelProps:function e(t,n){return[{id:"voice-command",label:"Intent",type:"combobox",entries:function e(){return S(n)},onChange:function e(r){let o=r.split(c);if(!(o.length>1))return;let i=o[0];let a=o[1];y(n,i,a).then(function(e){if(!e)return;let n=C(e);let r=R(e);if(n){k(t,n)}if(r){T(t,r)}})},state:t.get("xmlState")}]},shouldHaveInputs:function e(t){return t.attr("voice-command")}},action:function e(){let n=["1","1.5","2","2.5","3"];return[{id:"silencetime",defaultValue:"1.5",label:"Silence wait time (seconds)",helptext:"How long Skuid should wait, in seconds, after a user finishes speaking before sending the voice command",type:"picklist",picklistEntries:t.map(n,function(e){return{label:e,value:e}})}]}},methods:{beginConversation:function t(n,o,i,a){let u=r.convertToNumber(o.attr("silencetime"))||1.5;let s={botAlias:i["lex-chatbotalias"],botName:i["lex-chatbotname"],silenceTime:u,responseHandler:a.responseHandler||function(){},textSubmissionHandler:a.textSubmissionHandler||function(){},endOfConversationHandler:a.endOfConversationHandler||function(){},processingHandler:a.processingHandler||function(){},listeningHandler:a.listeningHandler||function(){}};return P(s,n).then(function(t){let n=t.intentName,r=t.$LEX,o=e.actionSequences.getAllVoiceCommandListeners(),i,a;for(let e=0;e<o.length;e++){a=o[e];i=a.getVoiceCommandId();if(i.split(c)[0]===n){return{actionSequence:a,inputs:r}}}})},conversationKillSwitch:x}},talkToLex:P,LexThinksConversationIsOngoing:M,_convertTextActionDefToParams:_})})()}});return t});